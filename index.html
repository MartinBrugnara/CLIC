<!DOCTYPE html>
<html>
<head>
    <!--
    CLIC what if?
    Esplora i metodi di aggiudicazione dell'offerta economicamente piu' vantaggiosa
    Copyright (C) 2018 Martin Brugnara - Università degli Studi di Trento

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <https://www.gnu.org/licenses/>.
    -->


    <meta charset="UTF-8">
    <title>CLIC: What if?</title>

    <link rel="stylesheet" href="node_modules/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="node_modules/\@fortawesome/fontawesome-free-webfonts/css/fontawesome.css">
    <link rel="stylesheet" href="node_modules/\@fortawesome/fontawesome-free-webfonts/css/fa-regular.css">
    <link rel="stylesheet" href="node_modules/\@fortawesome/fontawesome-free-webfonts/css/fa-solid.css">
    <link rel="stylesheet" href="static/css/index.css">
</head>
<body class="pb-5">

    <nav class="navbar navbar-dark bg-dark mb-4" id="app_status">
        <!-- Navbar content -->
        <a class="navbar-brand" href="#">CLIC</a>
        <span class="navbar-text text-white"><strong>Bando:</strong> {{ rpath }}</span>
        <div class="nav-item active flex-column">
            <div><span v-bind:class="{invisible: !read_only}" style="width:100%" class="badge badge-danger">Sola lettura</span></div>
            <div><span v-bind:class="{invisible: !modified}" style="width:100%" class="badge badge-warning">Modificato</span></div>
        </div>
    </nav>

    <div id="errors" class="container alert alert-danger" v-if="errors.length">
        <h4 class="alert-heading">Errori</h4>
        <ul>
            <li v-for="e in errors">{{ e }}</li>
        </ul>
    </div>

    <div id="structure" class="container">
        <h3>Offerta Economica</h3>
        <div class="container mb-2">
            <div class="form-row">
                <div class="form-group col-auto">
                    <label for="eco_base_asta">Modalit&agrave;</label>
                    <div class="form-check">
                        <input style="margin-top:0.05rem" class="form-check-input" type="radio" id="ribasso" value="ribasso" v-model="mod_economica">
                        <label class="form-check-label" for="ribasso">Ribasso</label>
                    </div>
                    <div class="form-check">
                        <input style="margin-top:0.05rem" class="form-check-input" type="radio" id="prezzo" value="prezzo" v-model="mod_economica">
                        <label class="form-check-label" for="prezzo">Prezzo</label>
                    </div>
                </div>

                <div class="form-group col-auto no-expand">
                    <label>Peso</label>
                    <input type="number" min="0" max="100" step="1" v-bind:class="{'form-control':true, 'is-invalid':top_werror}" v-model.number="peso_economica">
                    <!-- <small id="eco_base_asta_help" class="form-text text-muted">Decimale positivo con due cifre</small> -->
                </div>

                <div class="form-group col-auto" v-if="mod_economica == 'prezzo'">
                    <label for="eco_base_asta">Base d'asta</label>
                    <input type="number" min="0" step="0.01" class="form-control" name="eco_base_asta" id="eco_base_asta" aria-describedby="eco_base_asta_help" v-model.number="base_asta">
                    <!-- <small id="eco_base_asta_help" class="form-text text-muted">Decimale positivo con due cifre</small> -->
                </div>

                <div class="form-group col-auto">
                    <label for="eco_func">Formula</label>
                    <!--class="custom-select"-->
                    <select
                        class="form-control"
                        id="eco_func"
                        v-model="funzione_economica">
                        <option v-for="(o, fname) in funcs" v-bind:value="fname">{{ fname  | undash | capitalize }}</option>
                    </select>
                </div>

                <div class="form-group col-auto" v-if="eco_got_param">
                    <label>Parametri</label>

                    <div class="input-group">
                        <template
                            class="input-group"
                            v-for="(p, pname) in funcs[funzione_economica][mod_economica == 'prezzo' ? 'down' : 'up'].params">

                            <div class="input-group-prepend">
                                <span class="input-group-text">{{ pname | csub | undash }}</span>
                            </div>

                            <input
                                type="number"
                                v-bind:min=     "funcs[funzione_economica][mod_economica == 'prezzo' ? 'down' : 'up'].params[pname].domain.start"
                                v-bind:max=     "funcs[funzione_economica][mod_economica == 'prezzo' ? 'down' : 'up'].params[pname].domain.end"
                                v-bind:step=    "funcs[funzione_economica][mod_economica == 'prezzo' ? 'down' : 'up'].params[pname].domain.step"
                                v-bind:required="funcs[funzione_economica][mod_economica == 'prezzo' ? 'down' : 'up'].params[pname].required"
                                v-bind:name="pname"
                                class="form-control no-expand"
                                v-model.number="parametri_economica[pname]"
                            />
                        </template>
                    </div>
                </div>
            </div>
        </div>


        <h3>Offerta Tecnica</h3>

        <form class="form-inline">
            <label class="form-check-label">Riparametrizzazione:</label>
            <div class="form-check ml-2">
                <input type="checkbox" class="form-check-input" id="rep1" v-model="riparametrizzazione1">
                <label class="form-check-label" for="rep1">1&deg; livello.</label>
            </div>
            <div class="form-check ml-2">
                <input type="checkbox" class="form-check-input" id="rep2" v-model="riparametrizzazione2">
                <label class="form-check-label" for="rep2">2&deg; livello.</label>
            </div>
        </form>

        <ul id="ctree" class="nols">
            <!-- <li value="-1"># - &#931; - Tipo - &#120582;</li> -->

            <criterio
                v-for="(model, index) in criteri"
                v-bind:index="index"
                v-bind:model="model"
                v-bind:name="index+1"
                v-bind:depth="1"
                v-bind:werror="top_werror"></criterio>

            <span>
                <i @click="addCriterio('')" class="fas fa-plus action"></i>
                <label class="nextCid">({{ criteri.length + 1 }})</label>
            </span>
        </ul>
    </div>

    <!-- for style see input group from bootstrap -->
    <script type="text/x-template" id="tpl_criterio">
    <li>
        <!-- style is hack for align -->
        <form class="form-inline">
            <span class="mr-3">
                <label v-bind:style="{'min-width': padding, 'display': 'inline-flex'}" class="my-1 mr-1">{{name}}</label>

                <a role="button" data-toggle="popover" data-placement="right">
                    <i class="fas fa-info action ml-1"></i>
                </a>
                <div class="popper-content hide" v-model.trim="model.nome">
                    <input type="text" class="mono" placeholder="Nome del criterio"  v-model.trim="model.nome"
                        v-bind:size="amin([78, (model.nome||'').trim().length + 3])">
                </div>

                <i @click="sub()" v-bind:style="{'visibility': isLeaf ? 'inherit' : 'hidden' }" class="fas fa-sitemap action ml-1"></i>
                <i @click="remove()" class="far fa-trash-alt action"></i>
            </span>

            <div class="input-group">
                <div class="input-group-prepend">
                    <span class="input-group-text">&#931;</span>
                </div>
                <input type="number" min="0" max="100"
                    v-bind:class="{'is-invalid': werror, 'form-control': true}"
                    v-model.number="model.peso">
            </div>

            <!-- Note: hiding if got subcriteria -->
            <div class="input-group ml-2" v-if="isLeaf">
                <select class="custom-select no-expand" v-model="model.tipo" @change="fch">
                    <option value="Q">Q</option>
                    <option value="D">D</option>
                    <option value="T">T</option>
                </select>

                <select
                    class="custom-select"
                    v-if="model.tipo === 'Q'"
                    v-model="model.funzione"
                    @change="fch">
                    <option v-for="(o, fname) in funcs" v-bind:value="fname">{{ fname | undash | capitalize }}</option>
                </select>

                <div v-if="model.tipo == 'T'" class="input-group-append">
                    <span class="input-group-text">
                        <i @click="addVoce" class="fas fa-plus action"></i>
                    </span>
                </div>

            </div>

            <!-- TODO: What about force new line and then align right? -->
            <div class="input-group ml-2" v-if="isLeaf && model.tipo === 'Q'">
                <template v-for="(p, pname) in funcs[model.funzione].up.params">
                        <div class="input-group-prepend">
                            <span class="input-group-text">{{ pname | csub | undash }}</span>
                        </div>

                        <input
                            type="number"
                            v-bind:min="funcs[model.funzione].up.params[pname].domain.start"
                            v-bind:max="funcs[model.funzione].up.params[pname].domain.end"
                            v-bind:step="funcs[model.funzione].up.params[pname].domain.step"
                            v-bind:required="funcs[model.funzione].up.params[pname].required"
                            v-bind:name="pname"
                            class="form-control no-expand"
                            v-model.number="model.parametri[pname]"
                        />
                </template>
            </div>

            <template v-if="isLeaf">
                <div class="input-group ml-2"
                    v-if="model.tipo == 'T'"
                    v-for="(v, vi) in model.voci">

                        <div class="input-group-prepend">
                            <span class="input-group-text">{{ vi + 1 }}</span>
                        </div>
                        <input type="number" min="0" max="99" step="0.5"
                            v-bind:class="{'is-invalid': terror, 'form-control': true}"
                            v-model.number="model.voci[vi]">
                        <div class="input-group-append">
                            <span class="input-group-text">
                                <i @click="removeVoce(vi)" class="far fa-trash-alt action"></i>
                            </span>
                        </div>
                </div>
            </div>
        </form>

        <!-- Recursively enumerate subcriteria -->
        <!-- Error style alternative: bg-danger -->
        <ul v-if="!isLeaf" v-bind:class="{'border-danger': weightError}">
            <criterio
                v-for="(model, index) in model.subcriteri"
                v-bind:index="index"
                v-bind:key="index"
                v-bind:model="model"
                v-bind:name="name + '.' + (index + 1)"
                v-bind:depth="depth + 1"
                v-bind:werror="weightError">
            </criterio>
            <span>
                <i @click="add()" class="fas fa-plus action"></i>
                <label class="nextCid">({{ name + '.' + (model.subcriteri.length + 1) }})</label>
            </span>
        </ul>
    </li>
    </script>


    <div id="simulation">
        <div class="container d-flex">
            <div class="flex-fill text-left">
                <h3>Dati</h3>
            </div>
            <div class="d-flex align-items-end text-right mb-2">
                <strong>Modalit&agrave;</strong >
                <div class="form-check-inline ml-2">
                    <input style="margin-top:0.05rem" class="form-check-input" type="radio" id="points" value="points" v-model="env_data_mode">
                    <label class="form-check-label" for="points">Punti</label>
                </div>
                <div class="form-check-inline">
                    <input style="margin-top:0.05rem" class="form-check-input" type="radio" id="raw" value="raw" v-model="env_data_mode">
                    <label class="form-check-label" for="raw">Dati</label>
                </div>
                <div class="form-check-inline mr-0">
                    <input style="margin-top:0.05rem" class="form-check-input" type="radio" id="edit" value="edit" v-model="env_data_mode">
                    <label class="form-check-label" for="edit">Modifica</label>
                </div>
            </div>
        </div>

        <div class="text-center">
            <table id="data" class="table table-striped text-right pb-2 tbl">
                <thead>
                    <tr>
                        <th><span>#</span></th>
                        <th><span>Economica</span></th>
                        <th scope="col" v-for="c in cols" v-bind:colspan="c.tipo == 'T' && env_data_mode != 'points' ? c.voci.length : 1">

                            <a role="button" data-toggle="popover" data-placement="bottom" v-bind:data-content="c.nome">
                            <span v-bind:title="c.nome">{{c.env_name}}</span>
                </a>
                        </th>
                        <th scope="col">
                            <i class="fas fa-exclamation"></i>
                        </th>
                    </tr>
                    <tr>
                        <th><small>Peso</small></th>
                        <th>
                            <input v-if="env_data_mode == 'edit'" v-model.number="peso_economica" type="number" min="0" max="100" step="0.5">
                            <small v-else>{{peso_economica}}</small>
                        </th>

                        <template v-for="c in cols">
                            <template v-if="c.tipo == 'T'">
                                <th v-if="env_data_mode == 'points'"><small>{{c.peso}}</small></th>
                                <th v-else v-for="(v, vi) in c.voci">
                                    <!-- NOTE: 99 instead of 100 to fit same size as bottom -->
                                    <input v-if="env_data_mode == 'edit'" v-model.number="c.voci[vi]" type="number" min="0" max="99" step="0.5">
                                    <small v-else>{{c.voci[vi]}}</small>
                                </th>
                            </template>
                            <template v-else>
                                <th>
                                    <!-- NOTE: 99 instead of 100 to fit same size as bottom -->
                                    <input v-if="env_data_mode == 'edit'" v-model.number="c.peso" type="number" min="0" max="99" step="0.5">
                                    <small v-else>{{c.peso}}</small>
                                </th>
                            </template>
                        </template>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <tr v-for="(o, i) in offerte" :key="o.nome">
                        <template v-if="env_data_mode == 'edit'">
                            <td class="text-left"><input type="text" v-model.trim="o.nome"></td>
                            <td><input type="number" min="0.01" step="0.01" v-model.number="o.economica[0]"></td>
                            <template v-for="(t, ti) in o.tecnica">
                                <template v-if="cols[ti].tipo == 'T'">
                                    <td v-for="(v, vi) in cols[ti].voci" class="text-center">
                                        <input type="checkbox" v-model="t[vi]">
                                    </td>
                                </template>
                                <template v-else-if="cols[ti].tipo == 'D'">
                                    <td><input type="number" min="0" step="0.01" max="1" v-model.number="o.tecnica[ti]"></td>
                                </template>
                                <template v-else>
                                    <td><input type="number" min="0" step="0.01" v-model.number="o.tecnica[ti]"></td>
                                </template>
                            </template>
                            <td class="text-center"><!-- actions -->
                                <i @click="clone(i)" class="far fa-copy action"></i>
                                <i @click="remove(i)" class="far fa-trash-alt action"></i>
                            </td>
                        </template>

                        <template v-else>
                            <!-- TODO: Add color backgroud to show distribution -->
                            <td class="text-left">{{ o.nome }}</td>
                            <td v-if="env_data_mode == 'points'">{{ points[i].economica * peso_economica | prec2}}</td>
                            <td v-else>{{o.economica[0] | prec2}}</td>
                            <template v-for="(t, ti) in o.tecnica">
                                <template v-if="cols[ti].tipo == 'T'">
                                    <td v-if="env_data_mode == 'points'">
                                        {{ points[i].tecnica[ti] * cols[ti].peso | prec2 }}
                                    </td>
                                    <td v-else v-for="(v, vi) in cols[ti].voci" class="text-center">
                                        <!--
                                            Do not use awesome + js here.
                                            Only static content.
                                        -->
                                        <span v-if="t[vi]">&#x2714;</span>
                                        <span v-else>&#x2718;</span>
                                    </td>
                                </template>
                                <template v-else-if="env_data_mode == 'points'">
                                    <td>{{ points[i].tecnica[ti] * cols[ti].peso | prec2 }}</td>
                                </template>
                                <template v-else>
                                    <td>{{ t | prec2 }}</td>
                                </template>
                            </template>
                            <td class="text-center"><!-- actions -->
                                <i @click="clone(i)" class="far fa-copy action"></i>
                                <i @click="remove(i)" class="far fa-trash-alt action"></i>
                            </td>
                        </template>
                    </tr>
                </tbody>
                <caption class="text-center">
                    <i @click="add" class="fas fa-plus action"></i>
                </caption>
            </table>
        </div>

        <div class="text-center mt-4">
            <div class="container text-left">
                <h3>Ranking</h3>
            </div>

            <table id="rank" class="table table-striped text-right tbl">
                <thead>
                    <tr>
                        <th>
                            <span class="x-middle"></span>
                            <div class="d-inline-flex flex-column ml-2">
                                <input id="nome_asc" type="radio" v-model="env_data_orderby" value="nome_asc">
                                <label for="nome_asc" class="mb-0">&#x25B2;</label>
                                <input id="nome_desc" type="radio" v-model="env_data_orderby" value="nome_desc">
                                <label for="nome_desc" class="mb-0">&#x25BC;</label>
                            </div>
                        </th>
                        <th>
                            <span class="x-middle">Σ</span>
                            <div class="d-inline-flex flex-column ml-2">
                                <input id="agg_asc" type="radio" v-model="env_data_orderby" value="agg_asc">
                                <label for="agg_asc" class="mb-0">&#x25B2;</label>
                                <input id="agg_desc" type="radio" v-model="env_data_orderby" value="agg_desc">
                                <label for="agg_desc" class="mb-0">&#x25BC;</label>
                            </div>
                        </th>
                        <th>
                            <span class="x-middle">Electre</span>
                            <div class="d-inline-flex flex-column ml-2">
                                <input id="electre_asc" type="radio" v-model="env_data_orderby" value="electre_asc">
                                <label for="electre_asc" class="mb-0">&#x25B2;</label>
                                <input id="electre_desc" type="radio" v-model="env_data_orderby" value="electre_desc">
                                <label for="electre_desc" class="mb-0">&#x25BC;</label>
                            </div>
                        </th>
                        <th>
                            <span class="x-middle">Topsis</span>
                            <div class="d-inline-flex flex-column ml-2">
                                <input id="topsis_asc" type="radio" v-model="env_data_orderby" value="topsis_asc">
                                <label for="topsis_asc" class="mb-0">&#x25B2;</label>
                                <input id="topsis_desc" type="radio" v-model="env_data_orderby" value="topsis_desc">
                                <label for="topsis_desc" class="mb-0">&#x25BC;</label>
                            </div>
                        </th>
                    </tr>
                </thead>
                <tbody v-if="!fatalErrors">
                    <tr v-for="(o, oi) in scoreboard">
                        <td>{{ o.nome }}</td>
                        <td>{{ o.agg | prec2 }}</td>
                        <td>{{ o.electre }}</td>
                        <td>{{ o.topsis | prec2 }}</td>
                    </tr>
                </tbody>
                <caption v-if="fatalErrors">
                    <p style="color:darkred">Corregi gli errori per poter calcolare le classifiche.</p>
                </caption>
            </table>
        </div>

    </div>

    <script src="node_modules/jquery/jquery.min.js"></script>
    <script src="node_modules/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="node_modules/vue/dist/vue.min.js"></script>
    <script src="static/js/index.js"></script>
</body>
</html>
